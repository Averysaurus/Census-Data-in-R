---
title: "Census Data Wrangling and Mapping in R"
author: "Patty Frontiera"
date: "03/21/2019"
output: 
  html_document:
      toc: true
      number_sections: true
      toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Getting Started

## Setup

Welcome! While we're waiting:

* **Clone or download** the workshop files from: [https://github.com/dlab-geo/rCensus_workshop](https://github.com/dlab-geo/rCensus_workshop)
    - If you downloaded the zipfile, **unzip it**.
    - Make a note of the folder in which the files reside. 
    
    
* Open **RStudio**

* Open a new **R script** file

## Introduction

- About me

- About you
    - Your familiarity with US Census data
    - with geospatial data
    - with geospatial data in R

## Outline

- Describe primary Census data products

- Introduce R packages for working with Census Data

- Use those packages to fetch census data

- Use those packages to fetch census data plus census geograpic boundary files

- Make maps of census data

# Census Data Overview

## US Census Data

The "nation's leading provider of quality data about its people and economy."

<img src="data/census_page.png" width="700px"></img>

Available at [www.census.gov](www.census.gov)

## Primary Census Products

- Decennial Census

- American Community Survey (ACS)

##  Decennial Census

Complete count of the population every 10 years since `1790` 

Includes data on 

- population, by age & race/ethnicity 

- housing, by occupancy & tenure (owned, rented)

## American Community Survey (ACS)

- Annual survey of a sample of about 3 million household

- Provides estimates of demographic, social, economic & housing characteristics

- Includes margin of error values for the estimates.

 
## Decennial Census* vs ACS Data
| Demographic*    | Social             | Economic          | Housing           |
|-----------------|--------------------|-------------------|-------------------|
| Sex             | Families           | Income            | Tenure*           |
| Age             | Education          | Benefits          | Occupancy*        |
| Race            | Marital Status     | Employment Status | Structure Type    |
| Hispanic Origin | Fertility          | Occupation        | Housing Value     |
|                 | Grandparents       | Industry          | Taxes & Insurance |
|                 | Veterans           | Commuting         | Utilities         |
|                 | Disability Status  | Place of Work     | Mortgage          |
|                 | Language at Home   | Health Insurance  | Monthly Rent      |
|                 | Citizenship        |                   |                   |
|                 | Mobility           |                   |                   |



## Census Geographies

Census data are publicly available at one or more levels of geographic aggregation.

<img src="data/census_geo_hierarchy.png" height="400px"></img>

## Census Data & Census Geographies

<img src="data/census_data_by_prod_geo.png" width="800px"></img>

## ACS 5 Year Dataset RECOMMENDED

ACS 1 year and 5 year products are currently available 

- ACS 3 year no longer available

ACS 5 year data provdes much better estimates, lower margins of error

More data available for ACS 5 Year product


## Census Data Workflow

Identify your 

- topic of interest
- year(s)
- geographic level of detail
- for what locations?

Then determine what specific tables and variables
are available - ACS or Decennial?

## CAUTION

"If you want to measure change you can't change the measures!"

**Census tables, variables, geographies, and geographic boundaries change over time!**

Measuring change over time with census data is *it's own thing*, complex and not covered by this workshop!

# R Packages

## Packages for Working with Census Data

These are the ones we recommend and will use today.

- [tidycensus](https://walkerke.github.io/tidycensus) & [tigris](https://github.com/walkerke/tigris)

- [tidyverse](https://www.tidyverse.org/)
   
- [sf](https://r-spatial.github.io/sf/)


# tidycensus & tigris

## [tidycensus](https://walkerke.github.io/tidycensus)

Functions for accessing census decennial and ACS 5 year datasets via Census APIs

- only a subset of datasets / years available
- requires a `Census API key` 

## [tidycensus](https://walkerke.github.io/tidycensus)

Limited set of years available via `tidycensus`

- decennial census: 1990, 2000, and 2010
- ACS 5 yr: 2005-2010 through 2012-2016 are available. 
- Note: tidycensus referes to ACS 5year datasets by the endyear.
- 2013 - 2017 released [Dec 6, 2018](https://www.census.gov/programs-surveys/acs/news/data-releases/2017/release-schedule.html) by the Census. 
    - Need to check its availability in `tidycensus`.

##  [tigris](https://github.com/walkerke/tigris)

Provides access to census geographic data files

- detailed TIGER/Line boundary files (e.g., shapefiles), or
- simplified Cartographic boundary files
    
Also provides access to census `feature data`,

- eg, rivers, roads, coastlands, landmarks, and more
    

Used by `tidycensus` to access state, county, tract, block group, block, and ZCTA boundaries.

- Use `tigris` directly to access other census geographic data.
    
## tidycensus & tigris

Packages developed by [Kyle Walker](https://walkerke.github.io/) to make it easier to fetch data from Census websites and APIs in **R** and get that data in a useable format to analyze, plot, and map.

Check out his website to keep abreast of his great packages, blog posts and tutorials.

- http://personal.tcu.edu/kylewalker/

- https://walkerke.github.io/

Walker also develped a new [DataCamp](https://www.datacamp.com) course [Analyzing US Census Data in R!](https://www.datacamp.com/courses/analyzing-us-census-data-in-r)

- Highly recommended! First chapter free!


## [tidyverse](https://www.tidyverse.org/)

A collection of R Packages for data science
- developed primarily by [Hadley Wickham](http://hadley.nz/), Chief Scientist at [RStudio](https://www.rstudio.com/).

 - `dplyr` and `tidyr` for reshaping data

 - `ggplot2` for plotting

 - `purr`, `readr` and `tibble` for improved performance 

These packages are used by `tidyverse` under the hood.

## [sf](https://r-spatial.github.io/sf/)

Simple features for geospatial data objects and methods.

- Next generation R package for working with vector geospatial data
    - will soon supercede the `sp` package
    
`sf` includes the functionality of the `sp`, `rgdal`, `rgeos` and `proj4` packages.

- but with improved performance, simplified command syntax and easier workflows.

## Alternatives to Accessing Census Data in R

You can write code to access the [Census APIs](https://www.census.gov/data/developers/data-sets.html) directly.

You can download Census data directly from:

- [American Factfinder](https://factfinder.census.gov/faces/nav/jsf/pages/index.xhtml) or 
- [NHGIS.org](https://www.nhgis.org/)
- [Social Explorer](https://www.socialexplorer.com/)
    - Subscription service but FREE for UCB community

You can download Census `geographic data` directly on the [census website](https://www.census.gov/geo/maps-data/)


# Tutorial Time!

## Part 1

We will work through several exercises using `tidycensus` to fetch, wrangle and map census data.

## Loading packages

Load the packages we will use today

```{r, message=FALSE, warning=FALSE}
library(tidycensus)
library(tidyverse) 
library(tigris)
library(sf)
```

## Install any packages that you do not have on your computer

Also install any dependancies.

```{r, eval=FALSE}
# install.packages("tidyverse")
# install.packages("tidycensus")
# install.packages("sf")
```


## Census API Key

You need a census API key to programmatically fetch census data.

Get it here (pretty quick):

* (https://api.census.gov/data/key_signup.html)

For more info see:

* https://www.census.gov/data/developers/data-sets.html

## Install your Census API Key

Use the tidycensus function **census_api_key** to make tidycensus use your key when it fetches data from the census.

```{r, eval=F}
# Install your census api key - long alphanumeric string
census_api_key(THE_BIG_LONG_ALPHANUMERIC_API_KEY_YOU_GOT_FROM_CENSUS)
```

## Set working directory

Be sure to **Clone or downloaded & unzip** the workshop files from: [https://github.com/dlab-geo/rCensus_workshop](https://github.com/dlab-geo/rCensus_workshop)

* unzip if needed

THen, set your working directory this folder, e.g.,

* `setwd("~/Documents/Dlab/workshops/2019/rCensus_workshop")`

<img src="./data/swd.png" width="600px"></img>

# Fetching Decennial Census Data

## Population Data

Let's start by fetching **population data** from the 2010 Census **for all states**

In order to fetch census data you need to identify the census **variables** that contain the data of interest.

## Topics, Tables & Variables

Census data **variables** are organized in **tables**

Which are organized by **topic** or concept.

The tidycensus **load_variables** function can help with this step.

First, take a look at the function documentation.
```{r, eval=F}
?load_variables
```

## load_variables

Use `load_variables` to fetch all variables used in the 2010 census into a dataframe.
```{r}
vars2010 <- load_variables(year=2010,        # Year or end year for ACS
                           dataset = 'sf1',  # 'sf1' for decennial or 'acs5'
                           cache = TRUE)     # Whether to save fetched data locally
```

## Decennial Census Variables

Let's take a look at and discuss the resultant dataframe.

- How many 2010 census variables are in the dataframe?
```{r, eval=F}
View(vars2010)
```

## 2010 Decennial Census Tables

- Variables: 3,346

- Topics: Population, housing

- Tables: currenty `333` - *that's a lot*!
    - 177 population tables (identified with a ‘‘P’’) available to the block level 
    - 58 housing tables (identified with an ‘‘H’’) available to the block level
    - 82 population tables (identified with a ‘‘PCT’’) available to the census tract level
    - 4 housing tables (identified with an “HCT”) available to the census tract level
    - 10 population tables (identified with a “PCO”) available to the county level 
    - plus 2 additoinal PCT tables

## What Variable has the 2010 Total Population value? 

We can sort and filter the vars2010 dataframe to find it.

<img src="./data/census2010_vars.png" height="500px"></img>

## get_decennial

We can use the tidycensus function **get_decenial** to fetch the 2010 census data for total population by state.

First, check the documentation for the function.
```{r, eval=F}
?get_decennial
```

## get_decennial

Fetch total population by state (**P001001**) from the 2010 census using `get_decennial`.

```{r}

pop2010 <- get_decennial(geography = "state",   # census tabulation unit
                         variables = "P001001", # variable(s) of interest
                         year = 2010)           # census year
          
```

## View the Data

- How many rows and columns? 

- Do you see the expected number of states?

- What column contains the population counts?

- Do the data values see to be right?
```{r}
#pop2010
```

## Visualize results

We can visualize the data to get a quick overview of the distribution of data values.

It's a first step in exploratory data analysis and a last step in data communication.

`ggplot2` is the most commonly used R package for data visualization. 

- It is loaded when you load the `tidyverse` package.

Let's use it to visualize the population data.

## Plot 2010 Population by state

Use `ggplot2` to create an ordered horizontal bar chart.
```{r}
pop_plot<- ggplot(data=pop2010, aes(x=reorder(NAME,value), y=value/1000000)) + 
  geom_bar(stat="identity") + coord_flip() +
  theme_minimal() + 
  labs(title = "2010 US Population by State") +
  xlab("State") +
  ylab("in millions")
```

## Display the plot

```{r, echo=F}
pop_plot
```

## Challenge

Fetch population data by state for 2000.

*Don't assume variable names are the same across years.* Check first!

## Challenge Solution

Total Population in 2000

```{r, eval = F, code_folding = "hide"}
# What is the variable name in 2000?
vars2000 <- load_variables(year=2000, dataset = 'sf1', cache = T)

# Take a look and search in the dataframe
View(vars2000)

# Fetch the 2000 pop data
pop2000 <- get_decennial(geography = "state", variables = "P001001", year = 2000)

# Take a look (plot if time)
pop2000
```

## Limiting by Area of Interest

In the previous example we retrieved population data for all states.

- This is the default behavior if you don't specify a subset.

- But you can limit the data to be retrieved by subunits like state.

## Limit Areas of Interest

Let's fetch data for just 3 states.

```{r}
state_pop2010 <- get_decennial(geography = "state", # census tabulation unit
                         variables = "P001001",     # variables of interest
                         year = 2010,               # census year
                         state=c("CA","OR","WA"))   # Filter by states of interest

```

*Note we are referencing states by their abbrevation.*

## View Results
```{r}
state_pop2010
```

## Changing Census Tabulation unit

`get_decennial` accepts a number of different values for **tabulation unit**.

- Options include: `state`, `county`, `tract`, `block group`, `block`, and `ZCTA`.

Let's change the tabulation unit from `state` to `county`.
```{r}
co_pop2010 <- get_decennial(geography = "county",   # census tabulation unit
                            variables = "P001001",  # variables of interest
                            year = 2010)
```

## Changing Census Tabulation unit

View the county data to see what was retrieved.
```{r}
co_pop2010
```

## Challenge 

* Fetch population by **county** for just California

* Fetch population by **county** for Oregon & California

*Try it before you look ahead at solutions.*

## Challenge Solution
```{r}
## Fetch population by **county** for just California
co_pop2010_ca <- get_decennial(geography = "county",   # census tabulation unit
                            variables = "P001001",  # variables of interest
                            year = 2010,
                            state=c('CA'))
#co_pop2010_ca

## Fetch population by **county** for Oregon & California
co_pop2010_caor <- get_decennial(geography = "county",   # census tabulation unit
                               variables = "P001001",  # variables of interest
                               year = 2010,
                               state=c('CA','OR'))
co_pop2010_caor

```

## Challenge

* Fetch population by **tract** for all states.

* Fetch population by **tract** for California.

## Challenge Solution
```{r, eval=F}
## Fetch population by **tract** for California.
cal_pop2010_tracts <- get_decennial(geography = "tract",   # census tabulation unit
                                 variables = "P001001",  # variables of interest
                                 year = 2010,
                                 state=c('CA'))
cal_pop2010_tracts


## Fetch population by **tract** for all states.
pop2010_tracts <- get_decennial(geography = "tract",   # census tabulation unit
                                    variables = "P001001",  # variables of interest
                                    year = 2010)

pop2010_tracts  ## DOES THIS WORK?
```

## Fetching Census Tract Data

If you want census data at the tract level or below you **must** specifiy the state & county or counties.
```{r,}
tract_pop2010 <- get_decennial(geography = "tract",   # census tabulation unit
                         variables = "P001001",       # variable of interest
                         year = 2010,                 # census year
                         state="CA",                  # limit to state of California
                         county=c("Alameda","Contra Costa"))  # and only these counties
```

## Fetching Census Tract Data

View the results! How many census tracts are in these 3 counties?

```{r}
tract_pop2010
```

## Challenge

1. Fetch population by **county** for Alameda County, California

2. Fetch population by **tract** for the nine county Bay Area:
- Alameda, SF, Contra Costa, Marin County, Napa, 
- San Mateo, Santa Clara,  Solano,  Sonoma, Santa Cruz

Note: You can use names, abbreviations or FIPs codes for your `state` and `county`.

```{r}
# County FIPs Codes for
# Alameda, SF, Contra Costa, Marin County, Napa, 
# San Mateo, Santa Clara,  Solano,  Sonoma, santa cruz
nine_counties <- c("001", "075", "013", "041", "055", "081", "085", "095", "097")
```

## Challenge Solution

```{r}
#  population by **county** for Alameda County, California
alco_pop2010 <- get_decennial(geography = "county",   # census tabulation unit
                                 variables = "P001001",  # variables of interest
                                 year = 2010,
                                 state=c('CA'),
                                 county=c('Alameda County'))
#alco_pop2010

```

## Challenge Solution

Fetch population by **tract** for the nine county Bay Area
```{r}
# County FIPs Codes for
# Alameda, SF, Contra Costa, Marin County, Napa, 
# San Mateo, Santa Clara,  Solano,  Sonoma, santa cruz
nine_counties <- c("001", "075", "013", "041", "055", "081", "085", "095", "097")

bayarea_pop2010_tract <- get_decennial(geography = "tract",   # census tabulation unit
                         variables = "P001001",       # variable of interest
                         year = 2010,                 # census year
                         state="CA",                  # limit to state of California
                         county=nine_counties)  # and only these counties
#bayarea_pop2010_tract
```


## RECAP & QUESTIONS

Fetch population by **tract** for the nine county Bay Area
```{r, eval=F}
# County FIPs Codes for
# Alameda, SF, Contra Costa, Marin County, Napa, 
# San Mateo, Santa Clara,  Solano,  Sonoma, santa cruz
nine_counties <- c("001", "075", "013", "041", "055", "081", "085", "095", "097")

bayarea_pop2010 <- get_decennial(geography = "tract",   # census tabulation unit
                      variables = "P001001",            # variable of interest
                      year = 2010,                      # census year
                      state="CA",                       # limit to state of California
                     county=nine_counties)             # and only these counties

# View the data
bayarea_pop2010
```



## Fetching data for more than one census variable

What **three** things are new here?
```{r}
#urban rural pop for 3 counties
ur_pop10 <- get_decennial(geography = "county",  # census tabulation unit
                           variables = c(urban="P002002",rural="P002005"),
                           year = 2010, 
                           summary_var = "P002001",  # The denominator
                           state='CA',
                           county=c("Napa","Sonoma","Mendocino"))

```

## Fetching data for more than one census variable

What `three` things are new here?

1. You can specify more than one variable:
```
variables = c("P002002","P002005")
```

2. You can name the output columns.
```
variables = c(urban="P002002",rural="P002005")
```

3. You can identify a `summary_var`. 
```
summary_var = "P002001"
```

This value is the denominator - the total count of all people or households surveyed. The values in this column can be used as a demoninator for other calcuations like percent of total. 

## Take a look at the results
```{r}
ur_pop10
```

## Calculating Percents

The `summary_value` column comes in handy when you want to compute percent of total.

Here's one way to do it.
```{r}
# Calculate the percent of population that is Urban or Rural
ur_pop10 <- ur_pop10 %>%
            mutate(pct = 100 * (value / summary_value))

```

## Calculating Percents

Let's take a look at the output
```{r}
ur_pop10 # Take a look
```

## Plot it

Plots give us compact visual summaries of the data
```{r}
myplot <- ggplot(data = ur_pop10, 
          mapping = aes(x = NAME, fill = variable, 
                     y = ifelse(test = variable == "urban", 
                                yes = -pct, no = pct))) +
          geom_bar(stat = "identity") +
          scale_y_continuous(labels = abs, limits=c(-100,100)) +
          labs(title="Urban & Rural Population in Wine Country", 
               x="County", y = " Percent of Population", fill="") +
          coord_flip()
```
*Don't worry if you don't get all the ggplot code now. It's here for reference.*

## Plot it
```{r}
myplot
```

## Fetch all the data in one table

This is often helpful **but** you need to keep tract of the meaning of each variable.
```{r}
alco_pop10 <- get_decennial(geography = "tract", # Census tabulation unit
                           table =  "P002",      # Table of urban & rural population counts
                           year = 2010,          # Decennial census year
                           state='CA',           # Filter state
                           county="Alameda")     # Filter county

```

## Take a look
```{r}
unique(alco_pop10$variable) # What and how many unique vars in table?

head(alco_pop10,3)  # Take a look at output
```


## Output options

Let's try all three of these commands and then look at the ouput to see what's different?

```{r, eval=F}
get_decennial(geography = "state", variables = "P001001", year = 2010)

get_decennial(geography = "state", variables = c(pop10="P001001"), year = 2010)

get_decennial(geography = "state", variables = c(pop00="P001001"), year = 2010, 
              output="wide")
```

## Output options

```{r}
head(get_decennial(geography = "state", variables = "P001001", year = 2010),2)
head(get_decennial(geography = "state", variables = c(pop10="P001001"), year = 2010),2)
head(get_decennial(geography = "state", variables = c(pop00="P001001"), year = 2010, output="wide"), 2)
```


## Data Wrangling

Your R skills can help you reformat the data and make it more useable.

Let's fetch population data for 2010 & 2000 by state with **output=wide**.

- We will label the variables **pop00** and **pop10**.

Then we will combine these into one data frame.

## Data Wrangling

Fetch pop by state from both the 2000 and 2010 census
```{r}
pop2000 <- get_decennial(geography = "state", variables = c(pop00="P001001"), 
                         year = 2000, output="wide")

pop2010 <- get_decennial(geography = "state", variables = c(pop10="P001001"), 
                         year = 2010, output="wide")

```

## Merge population by state from both censuses

Save in a new dataframe with both columns
```{r}
pop2000_2010 <- pop2000 %>% merge(pop2010, by="NAME") %>%
                             select(NAME, pop00, pop10)

head(pop2000_2010,3)
```

## Save the data

Use `write.csv` to save a data frame to a `CSV` file.

```{r, eval=F}
write.csv(pop2000_2010, file="pop2000_2010.csv", row.names = FALSE)
```

# QUESTIONS?


# Part 2. Mapping


## Mapping Census Data with `tidycensus`

You can fetch geographic data by adding the parameter **geometry=TRUE** to `tidycensus` functions

- Under the hood, tidycensus calls the `tigris` package to fetch data from the Census Geographic Data APIs.

- Only a subset of data available via `tigris` can be accessed via `tidycensus`.

You can then use common mapping functions like `plot`, `ggplot` and `tmap` to make maps.

## Geometry Options

Before fetching geometry, we need to specify a few `tigris` options

- Set the `class` of returned data to be `sf` objects (not `sp`, the default)

- Set `tigris_use_cache` to TRUE

```{r}
# Tigris options - used by tidycensus
options(tigris_class = "sf")      # SP is the default format returned by tigris
options(tigris_use_cache = TRUE)  # Save retrieved data locally

```

Caching the data is important because it speeds things up if you often fetch census data for the same geographies over and over again.

## tigris cache directory

You may want to use the geographic data downloaded by tigris in other applications.

To do this, you need to know where the files are saved locally.

You can also specify where tigris should save cached data.
```{r, eval=F}
# Check the location of the tigris cached data
Sys.getenv('TIGRIS_CACHE_DIR') 

# Set it
tigris_cache_dir("~/Documents/gis_data/census")  # Folder for local data

# Check it again
Sys.getenv('TIGRIS_CACHE_DIR') 
```

## Fetch geographic boundary data with tidycensus

We fetch the geospatial data by setting **geometry=TRUE**.

```{r}
pop2010geo <- get_decennial(geography = "state", 
                          variables = c(pop10="P001001"), 
                          year = 2010, 
                          output="wide", 
                          geometry=TRUE) # Fetch geometry with the data for mapping
 
```

## Take a look

Let's take a minute to discuss the format of an `sf` spatial object.
```{r}
pop2010geo
```


## Geospatial Data in R

R `sf` objects include

- a dataframe with a `geometry` column named of `geometry`

    - The geometry can be of type POINT, LINE, POLYGON
    - or, MULTIPOINT, MULTILINE or MULTIPOLGYON

- a `CRS` (coordinate reference system), specified by
    - epsg(SRID) code
    - proj4string
    
## Census Data Coordinate Reference System (CRS)

All census geographic data use the `NAD83` CRS, or coordinate reference system.

`NAD83` stands for North American Datum of 1983. The geographic coordinates are longitude and latitude values encoded as decimal degrees.

`WGS84`, or [The World Geodetic System of 1984](https://en.wikipedia.org/wiki/World_Geodetic_System) is the most commonly used geographic CRS. The difference between points encoded in these two systems can vary, on average, up to 1 meter in the continental US.

Many geospatial operations require you transform data to a common CRS before conducting spatial analysis or mapping.  

As an in depth discussion of CRSs is outside the scope of this workshop, see [Geocomputation in R](https://geocompr.robinlovelace.net/reproj-geo-data.html) for more information.

## Mapping sf Spatial Objects

We can use `plot` to make a quick map the geometry stored in an `sf` spatial object.

```{r}
plot(pop2010geo$geometry)
```

## Question

What do you get if you plot the `sf` object without specifying "$geometry"


## The Challenge of US maps

The vast geographic extent and non-contiguous nature of the USA makes it difficult to map.

```{r, echo=F}
plot(pop2010geo$geometry) #view again
```

## Fetch geographic data with tidycensus, SHIFTED

tidycensus includes a `shift_geo` parameter to shift AK & HI to below Texas.
```{r}

pop2010geo_shifted <- get_decennial(geography = "state", 
                                    variables = c(pop10="P001001"), 
                                    output="wide",
                                    year = 2010, 
                                    geometry=TRUE, 
                                    shift_geo=TRUE)

```

## Shift Happens!
```{r}
plot(pop2010geo_shifted$geometry)
```

## Save it

You can save `sf` data to a shapefile using `st_write`

```{r, eval=F}
st_write(pop2010geo_shifted,"usa_2010_shifted.shp")
```

## Check your TIGRIS_CACHE_DIR to see it

```{r, eval=F}
my_cache_dir <- Sys.getenv('TIGRIS_CACHE_DIR') 

dir(my_cache_dir) # What files stored there?
```

## Mapping Data Values

```{r}
plot(pop2010geo_shifted['pop10'])
```

## ggplot2 Maps

```{r}
ggplot(pop2010geo_shifted, aes(fill = pop10)) + 
  geom_sf()
```

## ggplot2 Maps

Note the use of **geom_sf** which tells ggplot that spatial data objects are being mapped.
- this is a huge improvememnt!!

```{r}
ggplot(pop2010geo_shifted, aes(fill = pop10)) + 
  geom_sf()
```

## Challenge 

Create a `map` of CA Population in 2010 by county


## Challenge Solution

2010 pop Data for California Counties
```{r, eval=F}

#fetch it
cal_pop10 <- get_decennial(geography = "county", 
                           variables = "P001001",
                           year = 2010, 
                           state='CA',
                           geometry=TRUE)

# map it
#plot(cal_pop10['value'])
```


## Fetch County data for more than one state

We can fetch both the census data and the **geometry** for more than one state!

- *this is so much easier than any alternative approach!*
```{r}
west_pop10 <- get_decennial(geography = "county", 
                           variables =  "P001001",
                           year = 2010, 
                           state=c('CA','OR','NV',"AZ"),
                           geometry=T)
```

## Map it

These are just quick plots to make sure we got the right data!
```{r}
plot(west_pop10['value'])
```

## Census Tract Data

Fetching the data for all `tracts` in one state.

- **but** you need to specify one or more counties.
```{r}
# Fetch tract data 
alco_pop10 <- get_decennial(geography = "tract", 
                           variables = "P001001", 
                           year = 2010, 
                           state='CA',
                           county='Alameda',
                           geometry=T)
```

## Challenge

Fetch and map the 2010 population by census tract for Alameda and Countra Costa counties.


## Challenge Solution

Fetch Tract population & geometry data for Alameda & Contra Costa Counties

```{r}

alcc_pop10 <- get_decennial(geography = "tract", 
                      variables = "P001001", 
                      year = 2010, 
                      state='CA',
                      county=c("Alameda","Contra Costa"),
                      geometry=T) 
```

## Challenge Solution

Map it
```{r}
plot(alcc_pop10['value'])
```


## More Complex Challenge (if time)

Fetch and map the percent of San Francicso properties by census tract that were coded as rented in the 2010 Census.

To start, indentify the variables for the

- total number of hounsing units 

- number of renter occupied units

## Complex Challenge Solution

SF Rented Units, 2010 
```{r, eval=F}
sf_rented <- get_decennial(geography = "tract",  # census tabulation unit
                           variables =  "H004004",
                           year = 2010, 
                           summary_var = "H004001",  # Total Urban - the denominator
                           state='CA',
                           county='San Francisco',
                           geometry=T)

sf_pct_rented <- sf_rented[sf_rented$value > 0,] %>%
                 mutate(pct = 100 * (value / summary_value))

plot(sf_pct_rented['pct'])
```

# Questions?

# Part 3. ACS 5 year data

## ACS Data with tidycensus

The tidycensus workflow for ACS data is similar to that used for decennial census data.

- But there are many more variables in the ACS.

Because the ACS contains **sample data**, each ACS variable of interest includes both an **estimate** of the value and a **margin of error**.

## ACS 5 year

You can use the tidycensus **get_acs** function to retrieve data for the ACS 5 year products, beginning with the 2005 - 2010 dataset. 

The **default** end year for my version of `tidycensus` (as of Dec 4, 2018)  is **2016** for the 2012-2016 ACS 5 year dataset.

  
## Fetch List of ACS 5 year Variables
  
Let's start by fetching ACS 5-year 2016 data on poverty. 

We want to explore the number of folks living below the poverty level by census tract.

First we need to find the variable name(s)!

## Load ACS Table Vars

Load the ACS 2012-2016 5 year data variables into a dataframe.

- ACS 5 year datasets are referenced by `end year` in tidycensus!

Then take a look at the variable names, labels and concepts.

How many variables refer to the concept of poverty?

```{r}
acs2016vars <- load_variables(year=2016, dataset = 'acs5', cache = T)
#View(acs2016vars)
```

## ACS Tables and variables

Many hundreds (thousands?) more than for decennial census!

See the documentation on the [census website](https://www.census.gov/programs-surveys/acs/guidance/which-data-tool/table-ids-explained.html)

Types of tables:

- `B` prefix = base tables
- `C` = collapsed tables
- `DP` = data profiles
- `S` = Subject tables

## Census Reporter

ACS variables can  be confusing. 

The Census Reporter website (https://censusreporter.org) provides another tool for navigating topics, tables, and variable names.

Let's check it out to see what tables/variables we should use.

## Filter the ACS Variables

In RStudio, view the dataframe **acs2016vars** and interactively filter the name column to display only the variables in the table **C17002** 

Take a look at the different variables in this table.

What variable(s) contain the estimate of the number of people living below poverty?

## get_acs

Use the tidycensus `get_acs` function to fetch the poverty data for census tracts in San Francisco
```{r, eval=F}
?get_acs
```

## get_acs in action

Fetch the data in the table **C17002** that contain the counts of people living below 100% of the poverty line.
```{r}
sf_poor <- get_acs(geography = "tract",  
                   variables = c('C17002_002','C17002_003'), # poverty variables
                   year = 2016,          
                   state="CA",
                   summary_var = "C17002_001", # Est of num people - denom
                   county="San Francisco",
                   geometry=T)               
```

## View output

Let's take a look at the output of `get_acs` and discuss how it differs from `get_decennial`.

```{r, eval=F}
sf_poor
```

## Create Poverty Map, try 2

What are we mapping!
```{r}
# What are we mapping?
plot(sf_poor['estimate'])
```

## Create Poverty Map, try 2

```{r}
# Remove census tracts that have no people!
sf_poor <- subset(sf_poor, summary_est > 0)

# What are we mapping?
plot(sf_poor['estimate'])
```

## Calculating percents

Let's calculate the percent below poverty by tract.

```{r}
sf_poor <- sf_poor %>%
  mutate(pct = 100 * (estimate / summary_est))

head(sf_poor, 3)
```


## Group by and sum

We want to group the data by the geometry and then sum the data values so that we have one value per geometry.
```{r}
sf_poor_summed <- sf_poor %>%
  select(GEOID, estimate, pct, geometry) %>%
  group_by(GEOID) %>% 
  summarise(count_below_pov = sum(estimate),
            pct_below_pov = sum(pct))
```

## Group by and sum

```{r}
head(sf_poor_summed)
```

## Map Counts

Where are SF's poorest areas?
```{r}
plot(sf_poor_summed['count_below_pov'])

```

## Map Percents

Where are SF's poorest areas?
```{r}
plot(sf_poor_summed['pct_below_pov'])

```


## Challenge

The ACS **2013-2017** 5 year dataset was released Dec 6, 2018. 

Although my current version of `tidycensus` states that 2012-2016 is the latest ACS 5-year product, see if you can fetch & map the percent of people below poverty line in San Francisco using the **2013-2017** ACS 5-year data.

## Challenge Solution
```{r, eval=F}
sf_poor_2017 <- get_acs(geography = "tract",  
                   variables = c('C17002_002','C17002_003'), # poverty variables
                   year = 2017,          
                   state="CA",
                   summary_var = "C17002_001", # Est of num people - denom
                   county="San Francisco",
                   geometry=T)   

head(sf_poor_2017)
```


## Margins of Error (MOE)

We haven't talked about it but it may be important in your work with ACS data.

Math is needed to combine MOEs when you combine variables.

- tidycensus includes some nice [functions](https://walkerke.github.io/tidycensus/reference/index.html) for these calculations.

See this web page on how to handle [MOEs in tidycensus](https://walkerke.github.io/tidycensus/articles/margins-of-error.html)

# Questions?


# Maps with tmap - Demo

## tmap

The `tmap` package is great for making both static and interactive maps. It turns R into a `GIS`.

Let's check it out with our last dataframe.

## tmap

```{r}
library(tmap)
tmap_mode("view") # set mode to interactive

poverty_map <- tm_shape(sf_poor_summed) +
                  tm_polygons(col="pct_below_pov")
```

## tmap

View the map - click on tracts

```{r}
poverty_map
```

## tmap

There are a number of great tutorials online for working with `tmap`.

See the `References` at the end of this workshop document.

# Census Geographic Data Files

## Census Geographic Data Files

**Cartographic Boundary** vs **Detailed TIGER/Line** data

By default, `tidycensus` downloads census **cartographic boundary** data.

- These are simplifed geometries, clipped to coastlines. 

In `get_acs` you can also request the more detailed census **TIGER/Line** data.

The cartographic boundary data is great for mapping but the detailed data is often better for analysis.

Let's check it out.


## Fetch Cartographic Boundary Data
```{r}

sf_poor_cb <- get_acs(geography = "tract",   
                   variables = c('C17002_002','C17002_003'), # poverty variables
                   summary_var = "C17002_001",
                   year = 2016,           
                   state="CA",
                   county="San Francisco",
                   geometry=TRUE,
                   cb = TRUE)     # THIS IS THE DEFAULT!
```

## Fetch Detailed TIGER/Line Geometry
```{r}

sf_poor_tl <- get_acs(geography = "tract",   
                   variables = c('C17002_002','C17002_003'), # poverty variables       
                   summary_var = "C17002_001",
                   year = 2016,              
                   state="CA",
                   county="San Francisco",
                   geometry=TRUE,
                   cb = FALSE)  # Fetching the TIGER/Line data  
```


## Visualize differences with Tmap

zoom in to explore, especially around the coastline.
```{r}
tm_shape(sf_poor_tl) + tm_borders() +
tm_shape(sf_poor_cb) + tm_borders(col="red")

```


# Questions?

# Summary

## Summary

- `tidycensus` offers two key functions for fetching census tabular and geographic: **get_acs** and **get_decennial**

- Using `tidycensus` to fetch the tabular data or both tabular and geographic data is IMOH way easier than any alternatives, **IF** you (1) know R, (2)know a bit about working with geographic data in R.

- This approach is also scaleable if you want multiple census variables and geographies.

- If you just want to fetcch the geographic data it may be easier to use the **tigris** package or download it directly from the census.


## References

- [DataCamp](https://www.datacamp.com) course [Analyzing US Census Data in R!](https://www.datacamp.com/courses/analyzing-us-census-data-in-r)
- [Geocomputation in R](https://geocompr.robinlovelace.net/)
- [Creating beautiful demographic maps with tidycensus and tmap packages](https://www.zevross.com/blog/2018/10/02/creating-beautiful-demographic-maps-in-r-with-the-tidycensus-and-tmap-packages/)

## Related D-Lab Workshops

- R Fundamentals
- Geospatial Data in R, parts 1, 2, & 3
- Web Maps in R with Leaflet
- Geocoding & Mapping in R

# Extras for Enthusiasts

## Scaling Up Example

In this example we show you how you can read in census variables of interest from a file into an R dataframe. You can then use that dataframe to fetch data for all those variables using `tidycensus`.

```{r}

# Load cenvar lookup table of vars of interest
my_cenvar_df <-read.csv("data/cenvar_lookup.csv", strip.white = T, stringsAsFactors = F)

my_cenvar_df
```

## Fetch the ACS data

Fetch the ACS data for these variables for the 9 county bay area

```{r}
nine_counties <- c("001", "075", "013", "041", "055", "081", "085", "095", "097")
bay9_data <-get_acs(geography = "tract", 
                       variables = my_cenvar_df$my_cen_vars, 
                       year=2016,
                       state = "CA", 
                       county = nine_counties, 
                       geometry = T)

bay9_data
```

## Reformat Ouput

1. We only want to keep the estimate column for each variable of interest, plus the GEOID and geometry columns.

2. We then want to make the data `wide` using the `spread` function. This will put each estimate variable is in its own column.
```{r}
bay9_data2 <- bay9_data %>%
  select("GEOID", "variable", "estimate") %>%
  spread(key=variable, value=estimate)
```

## Take a look
```{r}
bay9_data2
```

## Rename the columns

Use the dataframe of census variables to rename the columns so that they are self-describing.
```{r}
colnames(bay9_data2)<-c("GEOID", my_cenvar_df$my_cen_var_names, "geometry")

```

## Take a look
```{r}

bay9_data2
```


## Fetching data for multiple years

This requires variable name to be the same across years!
```{r, eval=FALSE}
# use purr::map_df to get data for multiple years (must have same vars!)
pop90_10 <- map_df(c(1990, 2000, 2010), function(x) { 
  get_decennial(geography = "state",
  variables = c(totalpop = "P001001"),
  dataset = "sf1",
  year = x) %>%
  mutate(year = x) }
)

# View output
head(pop90_10)
tail(pop90_10)

# Plot it
pop90_10 %>% ggplot(aes(x=reorder(NAME,value), y=value/1000000, fill=factor(year))) + 
             geom_bar(stat="identity", position=position_dodge()) + coord_flip()

```


# Combining Census Data with Other Data

## Area Weighted Interpolation

One of the strenghts of the `sf` package is how relatively easy it is to reaggregate data from one geometry to another. This process is called areal interpolation.

Area weighted interpolation reaggregates the data based on the percent of area shared by input and output geometeries.

## Read in a Shapefile
```{r, eval=F}
sfnhoods<- st_read("data/sfnhoods.shp")
head(sfnhoods)
plot(sfnhoods['nhood'])
```

##  Check the CRS
```{r, eval=F}
st_crs(sfnhoods)
st_crs(sf_poor5)
```

## CRS transformation
```{r, eval=F}
sf_poor5_4326 = st_transform(sf_poor5, st_crs(sfnhoods))
```

## Area Weighted Interpolation

Reaggregate percent of people below poverty from census tract to neighborhood polygons.

```{r, eval=F}
sfhoods2 = st_interpolate_aw(sf_poor5_4326[, "pct_below_pov"], sfnhoods,
extensive = F) # True= aw sum; False= aw avg
```

## Map it
```{r, eval=F}
par(mfrow=c(1,2))
plot(sf_poor5['pct_below_pov'])
plot(sfhoods2['pct_below_pov'])
par(mfrow=c(1,1))
```

## Map it with `tmap`
```{r, eval=F}
tm_shape(sfhoods2) +
   tm_polygons(col="pct_below_pov")
```

## Combine the values
```{r, eval=F}
head(sfhoods2)
sfnhoods$pct_below_pov <- sfhoods2$pct_below_pov

# map again - click on polygons and view data in popups
# to confirm the AWI output values
tm_shape(sfnhoods) +
  tm_polygons(col="pct_below_pov", 
    popup.vars = c("nhood", "pct_below_pov")
  )
```

